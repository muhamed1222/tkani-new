// –ë–∞–∑–æ–≤—ã–π URL API (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: /api/v1/ (–Ω–æ–≤—ã–π) –∏ /api/ (—Å—Ç–∞—Ä—ã–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:1337/api';

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
const getAuthToken = () => {
  return localStorage.getItem('authToken') || null;
};

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
const getHeaders = (includeAuth = true, isFormData = false) => {
  const headers = {};

  // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º Content-Type –¥–ª—è FormData (–±—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  if (!isFormData) {
    headers['Content-Type'] = 'application/json';
  }

  if (includeAuth) {
    const token = getAuthToken();
    console.log('üîê getHeaders - –¢–æ–∫–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:', token ? `–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (${token.substring(0, 20)}...)` : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');

    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      console.log('üì§ –ó–∞–≥–æ–ª–æ–≤–æ–∫ Authorization —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    } else {
      console.warn('‚ö†Ô∏è getHeaders - –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—Ä–æ—Å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    }
  }

  console.log('üì§ –ò—Ç–æ–≥–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', headers);
  return headers;
};

// –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
class ApiService {
  constructor(baseURL = API_URL) {
    this.baseURL = baseURL;
  }

  // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
  async _handleResponse(response) {
    if (!response.ok) {
      let errorMessage = `HTTP error! status: ${response.status}`;

      // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
      if (response.status === 401) {
        errorMessage = "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
      } else if (response.status === 403) {
        errorMessage = "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω";
      } else if (response.status === 404) {
        errorMessage = "–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
      } else if (response.status === 500) {
        errorMessage = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
      }

      try {
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º response –¥–ª—è —á—Ç–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ response.json() –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        const responseClone = response.clone();
        const errorData = await responseClone.json();

        if (import.meta.env.DEV) {
          console.error('API Error Response:', {
            status: response.status,
            statusText: response.statusText,
            errorData
          });
        }

        // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫: { error: true, message: "..." }
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ > —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å—É
        if (errorData.message) {
          errorMessage = errorData.message;
        } else if (errorData.error && typeof errorData.error === 'string') {
          errorMessage = errorData.error;
        } else if (typeof errorData === 'string') {
          errorMessage = errorData;
        }
      } catch (parseError) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç
        try {
          const text = await response.text();
          if (text) {
            errorMessage = text;
          }
        } catch {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }

        if (import.meta.env.DEV) {
          console.error('Failed to parse error response:', parseError);
        }
      }

      const error = new Error(errorMessage);
      error.status = response.status;
      error.statusText = response.statusText;
      throw error;
    }

    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π (204 No Content), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
    if (response.status === 204) {
      return null;
    }

    const data = await response.json();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤: { success: true, data: {...} }
    // –ï—Å–ª–∏ –µ—Å—Ç—å success: false, —ç—Ç–æ –æ—à–∏–±–∫–∞
    if (data.success === false || data.error === true) {
      const error = new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
      error.status = response.status;
      throw error;
    }

    // –ï—Å–ª–∏ success: true, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏ success)
    // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
    if (data.success === true) {
      // –£–±–∏—Ä–∞–µ–º success –∏–∑ –æ—Ç–≤–µ—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ
      const { success, ...rest } = data;
      return rest;
    }

    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–±–µ–∑ success) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    return data;
  }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤
  async get(endpoint, params = {}, includeAuth = true) {
    try {
      const queryString = new URLSearchParams(params).toString();
      const url = `${this.baseURL}${endpoint}${queryString ? `?${queryString}` : ''}`;

      console.log('API GET Request:', {
        url,
        endpoint,
        baseURL: this.baseURL,
        includeAuth,
        headers: getHeaders(includeAuth)
      });

      const response = await fetch(url, {
        method: 'GET',
        headers: getHeaders(includeAuth),
      });

      console.log('API GET Response:', {
        status: response.status,
        statusText: response.statusText,
        ok: response.ok,
        headers: Object.fromEntries(response.headers.entries())
      });

      return await this._handleResponse(response);
    } catch (error) {
      console.error('API GET Error:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack,
        status: error.status
      });
      throw error;
    }
  }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–æ–≤
  async post(endpoint, data = {}, includeAuth = true, isFormData = false) {
    try {
      const body = isFormData ? data : JSON.stringify(data);

      if (import.meta.env.DEV) {
        console.log('API POST Request:', {
          url: `${this.baseURL}${endpoint}`,
          endpoint,
          includeAuth,
          isFormData,
          body: isFormData ? '[FormData]' : body
        });
      }

      const response = await fetch(`${this.baseURL}${endpoint}`, {
        method: 'POST',
        headers: getHeaders(includeAuth, isFormData),
        body: body,
      });

      if (import.meta.env.DEV) {
        console.log('API POST Response:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });
      }

      return await this._handleResponse(response);
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('API POST Error:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          status: error.status
        });
      }
      throw error;
    }
  }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è PUT –∑–∞–ø—Ä–æ—Å–æ–≤
  async put(endpoint, data = {}, includeAuth = true, isFormData = false) {
    try {
      const body = isFormData ? data : JSON.stringify(data);
      const response = await fetch(`${this.baseURL}${endpoint}`, {
        method: 'PUT',
        headers: getHeaders(includeAuth, isFormData),
        body: body,
      });

      return await this._handleResponse(response);
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('API PUT Error:', error);
      }
      throw error;
    }
  }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è DELETE –∑–∞–ø—Ä–æ—Å–æ–≤
  async delete(endpoint, includeAuth = true) {
    try {
      const response = await fetch(`${this.baseURL}${endpoint}`, {
        method: 'DELETE',
        headers: getHeaders(includeAuth),
      });

      return await this._handleResponse(response);
    } catch (error) {
      if (import.meta.env.DEV) {
        console.error('API DELETE Error:', error);
      }
      throw error;
    }
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  setAuthToken(token) {
    if (token) {
      localStorage.setItem('authToken', token);
    } else {
      localStorage.removeItem('authToken');
    }
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
  getAuthToken() {
    return getAuthToken();
  }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä API —Å–µ—Ä–≤–∏—Å–∞
const api = new ApiService();

// –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç
export const worksAPI = {
  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–∞–±–æ—Ç—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
  getAll: async (page = 1, limit = 12) => {
    return api.get('/works', {
      'populate': '*',
      'pagination[page]': page,
      'pagination[pageSize]': limit
    }, false);
  },

  // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ ID
  getById: async (id) => {
    return api.get(`/works/${id}`, {}, false);
  },
};

// –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤
export const catalogAPI = {
  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
  getProducts: async (params = {}) => {
    const strapiParams = {
      'populate': '*', // –í–∞–∂–Ω–æ: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      'publicationState': 'live'
    };

    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    if (params.page) strapiParams['pagination[page]'] = params.page;
    if (params.pageSize) strapiParams['pagination[pageSize]'] = params.pageSize;

    // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è Strapi v4
    if (params['filters[category][id][$eq]']) {
      strapiParams['filters[category][id][$eq]'] = params['filters[category][id][$eq]'];
    }
    if (params.categoryId) {
      strapiParams['filters[category][id][$eq]'] = params.categoryId;
    }
    if (params.brandId) {
      strapiParams['filters[brand][id][$eq]'] = params.brandId;
    }

    console.log('üì° Strapi –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤:', strapiParams);
    return api.get('/products', strapiParams, false);
  },

  // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID
  getProduct: async (id) => {
    return api.get(`/products/${id}`, {
      'populate': '*' // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    }, false);
  },

  // –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  getCategories: async () => {
    return api.get('/categories', {
      'populate': '*',
      'pagination[pageSize]': 100
    }, false);
  },

  // –ü–æ–ª—É—á–∏—Ç—å –±—Ä–µ–Ω–¥—ã
  getBrands: async () => {
    return api.get('/brands', {
      'populate': '*',
      'pagination[pageSize]': 100
    }, false);
  },
};

// src/http/api.js - –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–æ–¥—ã authAPI

// –ú–µ—Ç–æ–¥—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
export const authAPI = {
  // –í—Ö–æ–¥ - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –¥–ª—è Strapi
  login: async (email, password) => {
    return api.post('/auth/local', {
      identifier: email, // Strapi –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 'identifier' –≤–º–µ—Å—Ç–æ 'email'
      password: password
    }, false);
  },

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–π endpoint
  register: async (userData) => {
    const registerData = {
      username: userData.email,
      email: userData.email,
      password: userData.password,
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
      firstName: userData.firstName,
      lastName: userData.lastName,
      phone: userData.phone
    };

    console.log('üîµ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –∫–∞—Å—Ç–æ–º–Ω—ã–π endpoint:', registerData);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π endpoint –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ Strapi
    return api.post('/registration/register', registerData, false);
  },

  // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
  checkAuth: async () => {
    return api.get('/users/me?populate=*', {}, true);
  },

  // –í authAPI –≤ api.js –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–æ–¥ updateProfile:

  // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Strapi endpoint
  updateProfile: async (userData) => {
    const updateData = {};

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π (camelCase –∫–∞–∫ –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞)
    if (userData.firstName !== undefined) updateData.firstName = userData.firstName;
    if (userData.lastName !== undefined) updateData.lastName = userData.lastName;
    if (userData.email !== undefined) updateData.email = userData.email;

    console.log('üîµ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', updateData);
    console.log('üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º:', api.getAuthToken() ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π endpoint Strapi –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const currentUser = await api.get('/users/me?populate=*', {}, true);
    const userId = currentUser.id;

    console.log('üë§ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', userId);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å populate
    const response = await api.put(`/users/${userId}?populate=*`, updateData, true);

    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω, –æ—Ç–≤–µ—Ç:', response);

    return response;
  },

  // –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
  changePassword: async (oldPassword, newPassword) => {
    return api.post('/auth/change-password', {
      currentPassword: oldPassword,
      password: newPassword,
      passwordConfirmation: newPassword
    }, true);
  },

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
  forgotPassword: async (email) => {
    return api.post('/auth/forgot-password', { email }, false);
  },

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
  resetPassword: async (code, password, passwordConfirmation) => {
    return api.post('/auth/reset-password', {
      code,
      password,
      passwordConfirmation
    }, false);
  },

  // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
  logout: async () => {
    return api.post('/auth/logout', {}, true);
  },
};

// –ú–µ—Ç–æ–¥—ã –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
export const cartAPI = {
  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
  getCart: async () => {
    console.log('cartAPI.getCart: –ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞');
    try {
      const result = await api.get('/cart/', {}, false);
      console.log('cartAPI.getCart: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:', result);
      return result;
    } catch (error) {
      console.error('cartAPI.getCart: –û—à–∏–±–∫–∞:', error);
      throw error;
    }
  },

  // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
  addToCart: async (productId, quantity = 1) => {
    return api.post('/cart/add', {
      product_id: productId,
      quantity: quantity
    }, false);
  },

  // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
  updateCart: async (productId, quantity) => {
    return api.post('/cart/update', {
      product_id: productId,
      quantity: quantity
    }, false);
  },

  // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  removeFromCart: async (productId) => {
    return api.post('/cart/remove', {
      product_id: productId
    }, false);
  },

  // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
  clearCart: async () => {
    return api.post('/cart/clear', {}, false);
  },
};

// –ú–µ—Ç–æ–¥—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
export const ordersAPI = {
  // –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  createOrder: async (orderData = {}) => {
    return api.post('/orders/create', orderData, true);
  },

  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getMyOrders: async (params = {}) => {
    return api.get('/orders/my', params, true);
  },

  // –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
  getOrder: async (orderId) => {
    return api.get(`/orders/${orderId}`, {}, true);
  },

  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
  updateOrderStatus: async (orderId, status, comment) => {
    return api.put(`/orders/${orderId}/status`, {
      status: status,
      comment: comment
    }, true);
  },
};

// –ú–µ—Ç–æ–¥—ã –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
export const adminAPI = {
  // –¢–æ–≤–∞—Ä—ã
  getProducts: async (params = {}) => {
    return api.get('/admin/products', params, true);
  },

  createProduct: async (productData) => {
    const formData = new FormData();
    formData.append('title', productData.title);
    if (productData.description) formData.append('description', productData.description);
    formData.append('price', productData.price);
    if (productData.stock !== undefined) formData.append('stock', productData.stock);
    if (productData.category_id) formData.append('category_id', productData.category_id);
    if (productData.brand_id) formData.append('brand_id', productData.brand_id);
    if (productData.image) formData.append('image', productData.image);
    if (productData.discount !== undefined) formData.append('discount', productData.discount);
    if (productData.discount_price !== undefined) formData.append('discount_price', productData.discount_price);
    if (productData.article) formData.append('article', productData.article);
    if (productData.composition) formData.append('composition', productData.composition);
    if (productData.width) formData.append('width', productData.width);
    if (productData.density) formData.append('density', productData.density);
    if (productData.country) formData.append('country', productData.country);
    formData.append('is_new', productData.is_new ? 'true' : 'false');
    if (productData.images && productData.images.length > 0) {
      productData.images.forEach((image) => {
        formData.append('images', image);
      });
    }

    return api.post('/admin/products', formData, true, true);
  },

  updateProduct: async (productId, productData) => {
    const formData = new FormData();
    if (productData.title) formData.append('title', productData.title);
    if (productData.description !== undefined) formData.append('description', productData.description);
    if (productData.price !== undefined) formData.append('price', productData.price);
    if (productData.stock !== undefined) formData.append('stock', productData.stock);
    if (productData.category_id !== undefined) formData.append('category_id', productData.category_id);
    if (productData.brand_id !== undefined) formData.append('brand_id', productData.brand_id);
    if (productData.image) formData.append('image', productData.image);
    if (productData.discount !== undefined) formData.append('discount', productData.discount);
    if (productData.discount_price !== undefined) formData.append('discount_price', productData.discount_price);
    if (productData.article !== undefined) formData.append('article', productData.article || '');
    if (productData.composition !== undefined) formData.append('composition', productData.composition || '');
    if (productData.width !== undefined) formData.append('width', productData.width || '');
    if (productData.density !== undefined) formData.append('density', productData.density || '');
    if (productData.country !== undefined) formData.append('country', productData.country || '');
    if (productData.is_new !== undefined) formData.append('is_new', productData.is_new ? 'true' : 'false');
    if (productData.images && productData.images.length > 0) {
      productData.images.forEach((image) => {
        formData.append('images', image);
      });
    }

    return api.put(`/admin/products/${productId}`, formData, true, true);
  },

  deleteProduct: async (productId) => {
    return api.delete(`/admin/products/${productId}`, true);
  },

  // –ó–∞–∫–∞–∑—ã
  getAllOrders: async (params = {}) => {
    return api.get('/admin/orders', params, true);
  },

  getOrder: async (orderId) => {
    return api.get(`/admin/orders/${orderId}`, {}, true);
  },

  updateOrderStatus: async (orderId, status, comment) => {
    return api.put(`/admin/orders/${orderId}/status`, {
      status: status,
      comment: comment
    }, true);
  },

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  getUsers: async () => {
    return api.get('/admin/users', {}, true);
  },

  getUser: async (userId) => {
    return api.get(`/admin/users/${userId}`, {}, true);
  },

  updateUser: async (userId, userData) => {
    return api.put(`/admin/users/${userId}`, userData, true);
  },

  deleteUser: async (userId) => {
    return api.delete(`/admin/users/${userId}`, true);
  },

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  getStats: async () => {
    return api.get('/admin/stats', {}, true);
  },

  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
  getCategories: async () => {
    return api.get('/admin/categories', {}, true);
  },

  createCategory: async (categoryData) => {
    return api.post('/admin/categories', categoryData, true);
  },

  updateCategory: async (categoryId, categoryData) => {
    return api.put(`/admin/categories/${categoryId}`, categoryData, true);
  },

  deleteCategory: async (categoryId) => {
    return api.delete(`/admin/categories/${categoryId}`, true);
  },

  // –ë—Ä–µ–Ω–¥—ã
  getBrands: async () => {
    return api.get('/admin/brands', {}, true);
  },

  createBrand: async (brandData) => {
    return api.post('/admin/brands', brandData, true);
  },

  updateBrand: async (brandId, brandData) => {
    return api.put(`/admin/brands/${brandId}`, brandData, true);
  },

  deleteBrand: async (brandId) => {
    return api.delete(`/admin/brands/${brandId}`, true);
  },

  // –†–∞–±–æ—Ç—ã
  getWorks: async () => {
    return api.get('/admin/works', {}, true);
  },

  createWork: async (workData) => {
    const formData = new FormData();
    formData.append('title', workData.title);
    if (workData.description) formData.append('description', workData.description);
    if (workData.image) formData.append('image', workData.image);
    if (workData.link) formData.append('link', workData.link);
    if (workData.tags) formData.append('tags', workData.tags);

    return api.post('/admin/works', formData, true, true);
  },

  updateWork: async (workId, workData) => {
    const formData = new FormData();
    if (workData.title) formData.append('title', workData.title);
    if (workData.description !== undefined) formData.append('description', workData.description);
    if (workData.image) formData.append('image', workData.image);
    if (workData.link !== undefined) formData.append('link', workData.link || '');
    if (workData.tags !== undefined) formData.append('tags', workData.tags || '');

    return api.put(`/admin/works/${workId}`, formData, true, true);
  },

  deleteWork: async (workId) => {
    return api.delete(`/admin/works/${workId}`, true);
  },
};

// –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è tkans (–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ catalog)
export const tkansAPI = {
  getAll: async (params = {}) => {
    return catalogAPI.getProducts(params);
  },
  getById: async (id) => {
    return catalogAPI.getProduct(id);
  },
  getTypes: async () => {
    return catalogAPI.getCategories();
  },
  getBrands: async () => {
    return catalogAPI.getBrands();
  },
};

// –ú–µ—Ç–æ–¥—ã –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π —Ñ–æ—Ä–º—ã
export const contactAPI = {
  sendMessage: async (data) => {
    console.log('üìß –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ø–æ—á—Ç—É:', data);

    // TODO: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –ø–æ—á—Ç—É
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ - –≤—Å–µ–≥–¥–∞ —É—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
    return new Promise((resolve) => {
      setTimeout(() => {
        console.log('‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–æ—á—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
        console.log('üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∏—Å—å–º–∞:');
        console.log('   –ò–º—è:', data.name);
        console.log('   –¢–µ–ª–µ—Ñ–æ–Ω:', data.phone);
        console.log('   –°–æ–æ–±—â–µ–Ω–∏–µ:', data.message);
        resolve({ success: true, message: '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' });
      }, 1000);
    });
  }
}

export default api;